<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Assign Work</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    form label {
      display: block;
      margin: 10px 0;
    }
    .buttons, .listbutton {
      margin-top: 20px;
    }
    button {
      padding: 10px 20px;
      cursor: pointer;
    }
    .back-link {
      display: inline-block;
      margin-bottom: 20px;
      text-decoration: none;
      font-size: 16px;
    }
  </style>
</head>
<body>

  <a class="back-link" href="index.html">‚Üê Back</a>
  <h1>Assign Work</h1>

  <form id="assignmentForm">
    <label>
      Select Product:
      <select name="product" required>
        <option value="">-- Select Product --</option>
        <option value="Inner Bearing">Inner Bearing</option>
        <option value="CVT Tank">CVT Tank</option>
      </select>
    </label>

    <label>
      Quantity:
      <input type="number" name="quantity" min="1" placeholder="Enter quantity" required />
    </label>

    <label>
      Start Date:
      <input type="date" name="startDate" required />
    </label>

    <label>
      End Date:
      <input type="date" name="endDate" required />
    </label>

    <label>
      Working Hours per Day:
      <input type="number" name="dailyHours" min="1" max="24" required />
    </label>

    <button type="submit">Schedule</button>
  </form>

  <div class="listbutton">
    <div style="width: 100%; display: flex; gap: 20px; justify-content: center;">
      <button class="btn-view" style="width: 40%; background-color: #28a745;" onclick="window.location.href = 'list-inner-bearing.html'">View Inner Bearing Work</button>
      <button class="btn-view" style="width: 40%; background-color: #284ea7;" onclick="window.location.href = 'list-cvt-tank.html'">View CVT Tank Work</button>
    </div>
  </div>

  <div class="buttons">
    <button class="btn-reset" id="resetBtn">Reset Scheduler</button>
  </div>

  <script>
    const products = {
      "Inner Bearing": [
        { name: "Cutting", processTime: 30, machineNeeded: "VTL" },
        { name: "Slot Mill", processTime: 50, machineNeeded: "VMC 1" },
        { name: "Debour", processTime: 20, machineNeeded: "Manual 1" },
        { name: "Tapping", processTime: 12, machineNeeded: "CNC Tapping" },
        { name: "Marking", processTime: 3, machineNeeded: "Dot Marking" },
        { name: "Welding", processTime: 40, machineNeeded: ["Welding 1", "Welding 2", "Welding 3", "Welding 4"] }
      ],
      "CVT Tank": [
        { name: "Marking", processTime: 2, machineNeeded: "Dot Marking" },
        { name: "Bending", processTime: 24, machineNeeded: "Press Brake" },
        { name: "Setting", processTime: 20, machineNeeded: "Welding 3" },
        { name: "Full Weld", processTime: 40, machineNeeded: ["Welding 1", "Welding 2", "Welding 3", "Welding 4"] }
      ]
    };

    let schedule = JSON.parse(localStorage.getItem("scheduledTimeline")) || [];

    function isSunday(date) {
      return date.getDay() === 0;
    }

    function getWorkingDays(start, end) {
      const days = [];
      const current = new Date(start);
      while (current <= end) {
        if (!isSunday(current)) {
          days.push(new Date(current));
        }
        current.setDate(current.getDate() + 1);
      }
      return days;
    }

    function scheduleJob(productName, quantity, startDate, endDate, hoursPerDay) {
      const processList = products[productName];
      const totalMinutesRequired = quantity * processList.reduce((sum, p) => sum + p.processTime, 0);

      const workingDays = getWorkingDays(startDate, endDate);
      const availableMinutes = workingDays.length * hoursPerDay * 60;

      if (availableMinutes < totalMinutesRequired) {
        const requiredPerDay = Math.ceil(totalMinutesRequired / workingDays.length / 60);
        alert(`Not possible to finish. You need ~${requiredPerDay} working hours per day.`);
        return;
      }

      let remainingMinutes = totalMinutesRequired;
      let currentDateIndex = 0;
      let minutesUsedToday = 0;

      for (let i = 1; i <= quantity; i++) {
        for (const proc of processList) {
          const procMinutes = proc.processTime;
          let machine = Array.isArray(proc.machineNeeded)
            ? proc.machineNeeded[Math.floor(Math.random() * proc.machineNeeded.length)]
            : proc.machineNeeded;

          while (procMinutes > (hoursPerDay * 60 - minutesUsedToday)) {
            // Move to next day if not enough space today
            currentDateIndex++;
            minutesUsedToday = 0;
          }

          const jobDate = workingDays[currentDateIndex];
          const jobStart = new Date(jobDate);
          jobStart.setHours(9, 0, 0, 0);
          jobStart.setMinutes(jobStart.getMinutes() + minutesUsedToday);

          const jobEnd = new Date(jobStart.getTime() + procMinutes * 60000);

          schedule.push({
            product: productName,
            process: proc.name,
            machine,
            quantity: 1,
            start: jobStart,
            end: jobEnd,
            completed: false
          });

          minutesUsedToday += procMinutes;
        }
        minutesUsedToday += 60; // 1 hour break between units
      }

      localStorage.setItem("scheduledTimeline", JSON.stringify(schedule));
      alert("Schedule assigned!");
    }

    function resetScheduler() {
      schedule = [];
      localStorage.removeItem("scheduledTimeline");
    }

    document.getElementById("assignmentForm").addEventListener("submit", function (e) {
      e.preventDefault();
      const form = new FormData(e.target);
      const product = form.get("product");
      const quantity = parseInt(form.get("quantity")) || 0;
      const startDate = new Date(form.get("startDate"));
      const endDate = new Date(form.get("endDate"));
      const dailyHours = parseInt(form.get("dailyHours")) || 8;

      if (!product || quantity <= 0 || isNaN(dailyHours)) {
        alert("Please fill in all fields correctly.");
        return;
      }

      scheduleJob(product, quantity, startDate, endDate, dailyHours);
      e.target.reset();
    });

    document.getElementById("resetBtn").addEventListener("click", function () {
      const confirmReset = confirm("Are you sure you want to reset the entire schedule?");
      if (confirmReset) {
        resetScheduler();
        alert("Scheduler reset successfully!");
        window.location.reload();
      }
    });
  </script>

</body>
</html>
